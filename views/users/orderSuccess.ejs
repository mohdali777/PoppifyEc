<%- include('../partials/user/header') %>
<%- include('../partials/user/navbar') %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/vfs_fonts.js"></script>

<style>
.success-card {
    width: 600px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    background-color: #ffffff;
}

.icon {
    font-size: 4rem;
    color: #28a745;
}

.card-body h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
}

.card-body p {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.btn-lg {
    padding: 10px 20px;
    font-size: 1.1rem;
    border-radius: 8px;
}

.btn-primary {
    background-color: #007bff;
    border: none;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    color: #fff;
}

</style>

<div class="container text-center py-5">
    <div class="card mx-auto success-card">
        <div class="card-body">
            <div class="py-3">
                <i class="bi bi-check-circle-fill text-success icon"></i>
                <h1 class="my-4">Thank You!</h1>
                <p class="text-muted">Your order has been placed successfully.</p>
                <p class="text-muted">Order ID: <strong><%= orderId %></strong></p>
                <p class="text-muted">You will receive a confirmation email shortly.</p>
                <div class="mt-4">
                    <a href="/shop" class="btn btn-primary btn-lg">Continue Shopping</a>
                    <a href="/myorders" class="btn btn-outline-secondary btn-lg">View My Orders</a>
                    <!-- Download Invoice Button -->
                    <button href="" onclick="downloadInvoice('<%= orderId %>')" class="btn btn-success btn-lg">Download Invoice</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Function to download the invoice
    function downloadInvoice(orderId){
        fetch(`/download-invoice/${orderId}`,{method:"POST"}).then((response)=>{
           return response.json()
        }).then((data)=>{
   if(data.ok){
    console.log(data.message);
    const orderDetails = {
        orderId: data.order.orderId,
        date: new Date(data.order.createdAt).toLocaleDateString(),
        customer: {
          name: data.order.address.firstName,
          address: `${data.order.address.streetAddress}, ${data.order.address.city}`,
          email: data.order.address.email,
          phone: data.order.address.phone,
        },
        items: data.order.cartItems.map((item) => ({
          name: item.productName,
          quantity: item.quantity,
          price: item.price,
          total: item.total,
        })),
        total: data.order.totalPrice,
        paymentMethod: data.order.paymentMethod,
      };
      DownloadPdf(orderDetails);
   }
        })
    }
    
    function DownloadPdf(orderDetails) {
        console.log(orderDetails);
        
  const { orderId, date, customer, items, total, paymentMethod } = orderDetails;

  // Use destructured values dynamically in your PDF definition
  const docDefinition = {
    content: [
      { text: 'Invoice', style: 'header' },
      { text: `Invoice Number: ${orderId}`, margin: [0, 10, 0, 0] },
      { text: `Date: ${date}`, margin: [0, 0, 0, 10] },
      { text: 'Bill To:', style: 'subheader' },
      { text: `Name: ${customer.name}` },
      { text: `Address: ${customer.address}` },
      { text: `Email: ${customer.email}` },
      { text: `Phone: ${customer.phone}` },
      { text: 'Order Details:', style: 'subheader', margin: [0, 10, 0, 5] },
      {
        style: 'tableExample',
        table: {
          headerRows: 1,
          widths: ['*', 'auto', 'auto', 'auto'],
          body: [
            ['Item', 'Quantity', 'Unit Price', 'Total'],
            ...items.map((item) => [item.name, item.quantity, `$${item.price}`, `$${item.total}`]),
          ],
        },
        layout: 'lightHorizontalLines',
      },
      { text: `Total: $${total}`, style: 'total', margin: [0, 10, 0, 0] },
      { text: `Payment Method: ${paymentMethod}`, margin: [0, 5, 0, 0] },
    ],
  };

  pdfMake.createPdf(docDefinition).download(`Invoice-${orderId}.pdf`);
}

   
</script>

<%- include('../partials/user/footer') %>